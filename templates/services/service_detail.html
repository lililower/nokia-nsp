{% extends "base.html" %}

{% block title %}VPLS {{ service.service_id }} - Nokia NSP{% endblock %}
{% block page_title %}VPLS {{ service.service_id }} - {{ service.name }}{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- Service Info -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Service Details</h6>
        {% if service.status == 'deployed' %}
          <span class="badge bg-success">Deployed</span>
        {% elif service.status == 'planned' %}
          <span class="badge bg-warning text-dark">Planned</span>
        {% elif service.status == 'failed' %}
          <span class="badge bg-danger">Failed</span>
        {% elif service.status == 'deleted' %}
          <span class="badge bg-secondary">Deleted</span>
        {% endif %}
      </div>
      <div class="card-body">
        <table class="table table-borderless mb-0">
          <tr><th style="width:40%">Service ID</th><td>{{ service.service_id }}</td></tr>
          <tr><th>Name</th><td>{{ service.name }}</td></tr>
          <tr><th>Customer ID</th><td>{{ service.customer_id }}</td></tr>
          <tr><th>Description</th><td>{{ service.description|default:"—" }}</td></tr>
          <tr><th>Created By</th><td>{{ service.created_by|default:"—" }}</td></tr>
          <tr><th>Created</th><td>{{ service.created_at|date:"Y-m-d H:i" }}</td></tr>
          <tr><th>Updated</th><td>{{ service.updated_at|date:"Y-m-d H:i" }}</td></tr>
        </table>
      </div>
      {% if user.is_operator %}
      <div class="card-footer d-flex gap-2">
        {% if service.status == 'planned' or service.status == 'failed' %}
        <form method="post" action="{% url 'service_deploy' service.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-sm"
                  onclick="return confirm('Deploy this service to all devices?')">
            <i class="bi bi-cloud-upload me-1"></i>Deploy
          </button>
        </form>
        {% endif %}
        {% if service.status == 'deployed' %}
        <form method="post" action="{% url 'service_delete_deploy' service.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm"
                  onclick="return confirm('Remove this service from all devices?')">
            <i class="bi bi-trash me-1"></i>Delete from Devices
          </button>
        </form>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Devices & SAPs -->
  <div class="col-lg-6">
    <div class="card shadow-sm mb-3">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-router me-2"></i>Target Devices</h6>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr><th>Device</th><th>Hostname</th><th>Status</th></tr>
          </thead>
          <tbody>
            {% for device in service.devices.all %}
            <tr>
              <td><a href="{% url 'device_detail' device.pk %}">{{ device.name }}</a></td>
              <td>{{ device.hostname }}</td>
              <td>
                {% if device.status == 'online' %}
                  <span class="badge bg-success">Online</span>
                {% elif device.status == 'offline' %}
                  <span class="badge bg-danger">Offline</span>
                {% else %}
                  <span class="badge bg-secondary">Unknown</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center text-muted py-3">No devices assigned.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-plug me-2"></i>SAPs</h6>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr><th>Device</th><th>Port</th><th>VLAN</th></tr>
          </thead>
          <tbody>
            {% for sap in service.saps.all %}
            <tr>
              <td>{{ sap.device.name }}</td>
              <td><code>{{ sap.port }}</code></td>
              <td>{{ sap.vlan }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center text-muted py-3">No SAPs configured.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Deployment Logs -->
<div class="card shadow-sm mt-4">
  <div class="card-header">
    <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Deployment History</h6>
  </div>
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Time</th>
          <th>Device</th>
          <th>Action</th>
          <th>Status</th>
          <th>By</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for log in service.deployment_logs.all %}
        <tr>
          <td><small>{{ log.timestamp|date:"Y-m-d H:i:s" }}</small></td>
          <td>{{ log.device.name }}</td>
          <td><span class="text-capitalize">{{ log.action }}</span></td>
          <td>
            {% if log.status == 'success' %}
              <span class="badge bg-success">Success</span>
            {% else %}
              <span class="badge bg-danger">Failed</span>
            {% endif %}
          </td>
          <td>{{ log.deployed_by|default:"—" }}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary" type="button"
                    data-bs-toggle="collapse" data-bs-target="#log-{{ log.pk }}">
              <i class="bi bi-code"></i>
            </button>
          </td>
        </tr>
        <tr class="collapse" id="log-{{ log.pk }}">
          <td colspan="6">
            <div class="row g-2">
              <div class="col-md-6">
                <strong>Config Sent:</strong>
                <pre class="bg-dark text-light p-2 rounded small mt-1" style="max-height:200px;overflow:auto">{{ log.config_sent }}</pre>
              </div>
              <div class="col-md-6">
                <strong>Response:</strong>
                <pre class="bg-dark text-light p-2 rounded small mt-1" style="max-height:200px;overflow:auto">{{ log.response }}</pre>
              </div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center text-muted py-3">No deployment history.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="mt-3">
  <a href="{% url 'service_list' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Services
  </a>
</div>
{% endblock %}
